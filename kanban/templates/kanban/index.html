{% extends 'kanban/base.html' %}

{% block title %}–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="welcome-section">
    <h1>–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß</h1>
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</h2>
    <p>–≠—Ç–æ —É–¥–æ–±–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—à–∏—Ö –∑–∞–¥–∞—á –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
</div>

<!-- –ú–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
<div style="max-width: 800px; margin: 40px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="text-align: center; margin-bottom: 20px;">üìÖ –ë—ã—Å—Ç—Ä—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
    
    <div id="mini-calendar">
        <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è JavaScript'–æ–º -->
        <div style="text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
        <a href="{% url 'calendar' %}" 
           style="padding: 10px 20px; background: #6ba8e0; color: white; text-decoration: none; border-radius: 4px;">
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª–Ω–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é ‚Üí
        </a>
    </div>
</div>

<!-- –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
<div style="max-width: 800px; margin: 40px auto;">
    <h3>üéØ –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
    <div id="today-tasks">
        <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è JavaScript'–æ–º -->
    </div>
</div>

<style>
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6ba8e0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å
    function loadMiniCalendar() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        
        fetch(`/api/mini_calendar/?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('mini-calendar');
                
                let html = `
                    <div style="text-align: center; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                        ${data.month_name} ${data.year}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #eee;">
                `;
                
                // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
                const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                days.forEach(day => {
                    html += `<div style="text-align: center; padding: 5px; background: white; font-weight: bold; font-size: 12px;">${day}</div>`;
                });
                
                // –î–Ω–∏ –º–µ—Å—è—Ü–∞
                data.calendar.forEach(week => {
                    week.forEach(day => {
                        if (day === 0) {
                            html += '<div style="aspect-ratio: 1; background: white;"></div>';
                        } else {
                            const dayStr = `${data.year}-${data.month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                            const hasTasks = data.tasks_by_day && data.tasks_by_day[dayStr];
                            const isToday = day === today.getDate() && data.month === today.getMonth() + 1;
                            
                            html += `
                                <div style="aspect-ratio: 1; padding: 3px; background: white; position: relative; 
                                            cursor: pointer; border: ${isToday ? '2px solid #4CAF50' : '1px solid #eee'};
                                            ${hasTasks ? 'border-left: 3px solid #4CAF50;' : ''}"
                                     onclick="window.location.href='/calendar/${data.year}/${data.month}/#' + ${day}">
                                    <div style="font-size: 12px; font-weight: ${isToday ? 'bold' : 'normal'};">
                                        ${day}
                                    </div>
                                    ${hasTasks ? 
                                        `<div style="position: absolute; bottom: 3px; right: 3px; 
                                                   background: #4CAF50; color: white; width: 16px; 
                                                   height: 16px; border-radius: 50%; font-size: 10px; 
                                                   line-height: 16px; text-align: center;">
                                            ${data.tasks_by_day[dayStr].length}
                                        </div>` 
                                        : ''}
                                </div>
                            `;
                        }
                    });
                });
                
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
                document.getElementById('mini-calendar').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</p>';
            });
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–¥–∞—á–∏
    function loadTodayTasks() {
        const today = new Date().toISOString().split('T')[0];
        
        fetch(`/api/tasks/by_date/?date=${today}`)
            .then(response => response.json())
            .then(tasks => {
                const container = document.getElementById('today-tasks');
                
                if (tasks.length === 0) {
                    container.innerHTML = '<p>üéâ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç!</p>';
                    return;
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
                
                tasks.forEach(task => {
                    html += `
                        <div style="padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h4 style="margin: 0 0 10px 0; color: #333;">${task.title}</h4>
                                <span style="background: ${task.status_color || '#666'}; color: white; 
                                           padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                    ${task.status_name || '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞'}
                                </span>
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                –î–æ—Å–∫–∞: ${task.board_name || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                <button onclick="window.location.href='/board/${task.id}/edit/'"
                                        style="padding: 5px 10px; background: #6ba8e0; color: white; 
                                               border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button onclick="completeTask(${task.id})"
                                        style="padding: 5px 10px; background: #4CAF50; color: white; 
                                               border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
                document.getElementById('today-tasks').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</p>';
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
    function completeTask(taskId) {
        if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?')) {
            fetch(`/api/tasks/${taskId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({status: 3}) // ID —Å—Ç–∞—Ç—É—Å–∞ "–í—ã–ø–æ–ª–Ω–µ–Ω—ã"
            })
            .then(response => {
                if (response.ok) {
                    loadTodayTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    alert('–ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è!');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            });
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadMiniCalendar();
        loadTodayTasks();
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}