{% extends 'kanban/base.html' %}

{% block title %}–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - {{ board.name }}{% endblock %}

{% block content %}
  <div style="display: flex; gap: 30px; max-width: 1400px; margin: 0 auto; padding: 20px;">
    
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div style="width: 300px; flex-shrink: 0;">
      <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h3 style="margin-top: 0; text-align: center; color: #333;">
          üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á
        </h3>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ—Å—è—Ü–∞ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <button onclick="changeCalendarMonth(-1)" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚Üê</button>
          <span id="calendar-month" style="font-weight: bold;"></span>
          <button onclick="changeCalendarMonth(1)" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚Üí</button>
        </div>
        
        <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 2px;">
          <div style="text-align: center; font-size: 12px; font-weight: bold; color: #ff4444;">–ü–Ω</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold;">–í—Ç</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold;">–°—Ä</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold;">–ß—Ç</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold;">–ü—Ç</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold;">–°–±</div>
          <div style="text-align: center; font-size: 12px; font-weight: bold; color: #4444ff;">–í—Å</div>
        </div>
        
        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div id="board-mini-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
        
        <!-- –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–ª–Ω–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é -->
        <div style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
          <a href="{% url 'calendar' %}" style="font-size: 12px; color: #6ba8e0; text-decoration: none;">
            –ü–æ–ª–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Üí
          </a>
        </div>
      </div>
      
      <!-- –ë–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã -->
      <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h4 style="margin-top: 0; color: #333;">‚è∞ –ë–ª–∏–∂–∞–π—à–∏–µ –¥–µ–¥–ª–∞–π–Ω—ã</h4>
        <div id="upcoming-deadlines">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –¥–æ—Å–∫–∞ –∑–∞–¥–∞—á -->
    <div style="flex-grow: 1;">
      <h1 style="margin-top: 0;">–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - {{ board.name }}</h1>
      
      <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å ID –¥–æ—Å–∫–∏ –¥–ª—è JavaScript -->
      <div id="board-data" data-board-id="{{ board.id }}" style="display: none;"></div>
      
      <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
      <div style="margin: 10px 0 30px 0; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <div style="flex-grow: 1;">
            <input id="new-task-title"
                   type="text"
                   placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞"
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" />
          </div>
          
          <div class="task-input-wrapper" style="position: relative;">
            <input id="new-task-deadline"
                   type="date"
                   style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" />
            <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none;">
              üìÖ
            </span>
          </div>

          <select id="new-task-status" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
          </select>

          <button onclick="createTask()" 
                  style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>

      <!-- –î–æ—Å–∫–∞ –∑–∞–¥–∞—á -->
      <div id="board" class="board"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
  <div id="edit-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:10000;">
    <!-- ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ... -->
  </div>
{% endblock %}

{% block scripts %}
<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—è
  let currentCalendarYear = new Date().getFullYear();
  let currentCalendarMonth = new Date().getMonth() + 1;
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—è
  function loadBoardMiniCalendar() {
    fetch(`/api/board_mini_calendar/?board_id={{ board.id }}&year=${currentCalendarYear}&month=${currentCalendarMonth}`)
      .then(response => response.json())
      .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Å—è—Ü–∞
        document.getElementById('calendar-month').textContent = `${data.month_name} ${data.year}`;
        
        const container = document.getElementById('board-mini-calendar');
        container.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        data.calendar.forEach(week => {
          week.forEach(day => {
            const dayDiv = document.createElement('div');
            dayDiv.style.aspectRatio = '1';
            dayDiv.style.padding = '4px';
            dayDiv.style.textAlign = 'center';
            dayDiv.style.fontSize = '14px';
            dayDiv.style.cursor = 'pointer';
            dayDiv.style.position = 'relative';
            
            if (day === 0) {
              dayDiv.style.background = '#f9f9f9';
            } else {
              const dayStr = `${data.year}-${data.month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
              const isToday = new Date().toISOString().split('T')[0] === dayStr;
              const hasTasks = data.tasks_by_day && data.tasks_by_day[dayStr];
              
              // –°—Ç–∏–ª–∏ –¥–ª—è –¥–Ω—è
              if (isToday) {
                dayDiv.style.background = '#e3f2fd';
                dayDiv.style.fontWeight = 'bold';
                dayDiv.style.border = '2px solid #2196F3';
              } else {
                dayDiv.style.background = 'white';
                dayDiv.style.border = '1px solid #eee';
              }
              
              if (hasTasks) {
                dayDiv.style.borderLeft = '3px solid #4CAF50';
              }
              
              // –ß–∏—Å–ª–æ –¥–Ω—è
              dayDiv.innerHTML = `
                <div>${day}</div>
                ${hasTasks ? 
                  `<div style="position: absolute; bottom: 2px; right: 2px; width: 6px; height: 6px; 
                            background: #4CAF50; border-radius: 50%;"></div>` 
                  : ''}
              `;
              
              // –ö–ª–∏–∫ –ø–æ –¥–Ω—é
              dayDiv.onclick = function() {
                openDayTasks(dayStr);
              };
            }
            
            container.appendChild(dayDiv);
          });
        });
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è:', error);
        if (hasTasks) {
    dayDiv.title = `${data.tasks_by_day[dayStr].length} –∑–∞–¥–∞—á`;
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∑–∞–¥–∞—á
    dayDiv.addEventListener('mouseenter', function(e) {
        if (data.tasks_by_day[dayStr]) {
            const tooltip = document.createElement('div');
            tooltip.style.position = 'absolute';
            tooltip.style.background = 'white';
            tooltip.style.padding = '8px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            tooltip.style.zIndex = '1000';
            tooltip.style.maxWidth = '200px';
            tooltip.style.fontSize = '12px';
            
            let tasksText = '<strong>–ó–∞–¥–∞—á–∏:</strong><br>';
            data.tasks_by_day[dayStr].forEach(task => {
                tasksText += `‚Ä¢ ${task.title}<br>`;
            });
            tooltip.innerHTML = tasksText;
            
            dayDiv.appendChild(tooltip);
        }
    });
    
    dayDiv.addEventListener('mouseleave', function() {
        const tooltip = this.querySelector('div[style*="position: absolute"]');
        if (tooltip) {
            tooltip.remove();
        }
    });
}
      });
  }
  
  // –°–º–µ–Ω–∞ –º–µ—Å—è—Ü–∞ –≤ –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä–µ
  function changeCalendarMonth(delta) {
    currentCalendarMonth += delta;
    
    if (currentCalendarMonth > 12) {
      currentCalendarMonth = 1;
      currentCalendarYear++;
    } else if (currentCalendarMonth < 1) {
      currentCalendarMonth = 12;
      currentCalendarYear--;
    }
    
    loadBoardMiniCalendar();
  }
  
  // –û—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á –¥–Ω—è
  function openDayTasks(dayStr) {
    fetch(`/api/tasks/by_date/?date=${dayStr}&board_id={{ board.id }}`)
      .then(response => response.json())
      .then(tasks => {
        if (tasks.length > 0) {
          let message = `–ó–∞–¥–∞—á–∏ –Ω–∞ ${dayStr}:\n`;
          tasks.forEach(task => {
            message += `‚Ä¢ ${task.title} (${task.status_name || '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞'})\n`;
          });
          alert(message);
        } else {
          alert(`–ù–∞ ${dayStr} –Ω–µ—Ç –∑–∞–¥–∞—á`);
        }
      });
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤
  function loadUpcomingDeadlines() {
    fetch(`/api/upcoming_deadlines/?board_id={{ board.id }}&days=7`)
      .then(response => response.json())
      .then(tasks => {
        const container = document.getElementById('upcoming-deadlines');
        
        if (tasks.length === 0) {
          container.innerHTML = '<p style="color: #666; font-size: 14px;">–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤</p>';
          return;
        }
        
        let html = '';
        tasks.forEach(task => {
          const daysLeft = Math.ceil((new Date(task.deadline) - new Date()) / (1000 * 60 * 60 * 24));
          let urgencyClass = '';
          
          if (daysLeft < 0) {
            urgencyClass = 'overdue';
          } else if (daysLeft === 0) {
            urgencyClass = 'today';
          } else if (daysLeft <= 3) {
            urgencyClass = 'urgent';
          }
          
          html += `
            <div style="padding: 8px; margin-bottom: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${task.color || '#6ba8e0'};">
              <div style="font-weight: bold; font-size: 14px;">${task.title}</div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                <span style="font-size: 12px; color: #666;">${task.deadline}</span>
                <span class="deadline-badge ${urgencyClass}" style="font-size: 11px; padding: 2px 6px; border-radius: 10px; background: ${getUrgencyColor(daysLeft)}; color: white;">
                  ${getDaysText(daysLeft)}
                </span>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–¥–ª–∞–π–Ω–æ–≤:', error);
      });
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ–¥–ª–∞–π–Ω–æ–≤
  function getUrgencyColor(daysLeft) {
    if (daysLeft < 0) return '#dc3545'; // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
    if (daysLeft === 0) return '#ff9800'; // –°–µ–≥–æ–¥–Ω—è
    if (daysLeft <= 3) return '#ffc107'; // –°—Ä–æ—á–Ω–æ
    return '#28a745'; // –ù–æ—Ä–º–∞–ª—å–Ω–æ
  }
  
  function getDaysText(daysLeft) {
    if (daysLeft < 0) return `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${Math.abs(daysLeft)}–¥`;
    if (daysLeft === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (daysLeft === 1) return '–ó–∞–≤—Ç—Ä–∞';
    return `${daysLeft}–¥`;
  }
  
  function getStatusColor(statusName) {
    const statusColors = {
        '–û–∂–∏–¥–∞–Ω–∏–µ': '#9E9E9E',
        '–í —Ä–∞–±–æ—Ç–µ': '#FF9800',
        '–í—ã–ø–æ–ª–Ω–µ–Ω—ã': '#4CAF50',
        '–û—Ç–ª–æ–∂–µ–Ω–æ': '#795548',
        '–û—Ç–º–µ–Ω–µ–Ω–æ': '#F44336'
    };
    return statusColors[statusName] || '#6ba8e0';
}
  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    loadBoardMiniCalendar();
    loadUpcomingDeadlines();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(loadUpcomingDeadlines, 5 * 60 * 1000);
  });
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –∫–æ–¥ –¥–ª—è –¥–æ—Å–∫–∏ (createTask, fetchBoard –∏ —Ç.–¥.)
  // ... –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π JavaScript –∫–æ–¥ ...
</script>

<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∏–Ω–∏-–∫–∞–ª–µ–Ω–¥–∞—Ä—è */
  #board-mini-calendar > div:hover {
    transform: scale(1.05);
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .deadline-badge.overdue {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  .mini-calendar-day {
    transition: all 0.2s ease;
    cursor: pointer;
    user-select: none;
}

.mini-calendar-day:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.mini-calendar-day.today {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    font-weight: bold;
}

.mini-calendar-day.has-tasks::after {
    content: '';
    position: absolute;
    bottom: 3px;
    right: 3px;
    width: 6px;
    height: 6px;
    background: #4CAF50;
    border-radius: 50%;
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.deadline-item {
    transition: all 0.2s;
    border-left-width: 4px !important;
}

.deadline-item:hover {
    transform: translateX(5px);
    background: #f0f7ff !important;
}
</style>
{% endblock %}