{% extends 'kanban/base.html' %}

{% block title %}–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - {{ board.name }}{% endblock %}

{% block content %}
  <h1>–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - {{ board.name }}</h1>
  
  <!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å ID –¥–æ—Å–∫–∏ –¥–ª—è JavaScript -->
  <div id="board-data" data-board-id="{{ board.id }}" style="display: none;"></div>
  
  <div style="margin: 10px 0;">
    <div class="task-input-wrapper">
      <input id="new-task-title"
             type="text"
             placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞"
             class="task-title-input" />

      <input id="new-task-deadline"
             type="date"
             class="task-date-input" />

      <span class="task-date-icon">üìÖ</span>
    </div>

    <select id="new-task-status" style="margin-left: 10px;">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
    </select>

    <button onclick="createTask()" style="margin-left: 8px;">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div id="board" class="board"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
  <div id="edit-modal" style="display:none;
                               position:fixed;
                               top:0; left:0; right:0; bottom:0;
                               background:rgba(0,0,0,0.4);
                               align-items:center;
                               justify-content:center;
                               z-index:10000;">
    <div id="edit-dialog" style="background:white; padding:16px; border-radius:8px; width:500px; max-width:90vw;">
      <h3 id="edit-dialog-header" style="cursor: move; margin-top:0;">
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
      </h3>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><br>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px;"><br>
      <label>–ó–∞–º–µ—Ç–∫–∞:</label><br>
      <textarea id="edit-desc" rows="4" style="width:100%;"></textarea><br><br>
      <label>–î–µ–¥–ª–∞–π–Ω:</label><br>
      <input id="edit-deadline" type="date" style="width:100%; margin-bottom:8px;"><br>
      <label>–¶–≤–µ—Ç –∑–∞–¥–∞—á–∏:</label><br>
      <input id="edit-color" type="color" style="width:100%; margin-bottom:8px;"><br>
      
      <!-- –°–µ–∫—Ü–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 10px;">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h4>
        <div id="file-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;">
          <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div id="file-upload-section" style="border: 2px dashed #ddd; padding: 15px; text-align: center; border-radius: 5px; margin-bottom: 10px;">
          <input type="file" id="file-input" style="display: none;" multiple>
          <button onclick="document.getElementById('file-input').click()" 
                  style="background: #6ba8e0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
            üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
          </button>
          <div id="file-info" style="font-size: 12px; color: #666;"></div>
          <div id="upload-progress" style="display: none; margin-top: 10px;">
            <div style="background: #f0f0f0; border-radius: 10px; overflow: hidden;">
              <div id="progress-bar" style="height: 20px; background: #4CAF50; width: 0; transition: width 0.3s;"></div>
            </div>
            <div id="progress-text" style="text-align: center; margin-top: 5px; font-size: 12px;">0%</div>
          </div>
        </div>
        
        <div style="font-size: 12px; color: #666;">
          –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB. –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF, DOC, XLS, TXT, –∞—Ä—Ö–∏–≤—ã.
        </div>
      </div>
      
      <div style="margin-top: 16px; display: flex; gap: 8px;">
        <button id="edit-save-btn" style="flex: 1; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button id="edit-cancel-btn" style="flex: 1; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  console.log('KANBAN SCRIPT LOADED');

  // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
  const board = document.getElementById('board');
  const currentBoardId = document.getElementById('board-data').dataset.boardId;
  let draggedTask = null;
  let editingTaskId = null;
  let summaryCollapsed = true;
  let availableStatuses = []; // –•—Ä–∞–Ω–∏–º —Å—Ç–∞—Ç—É—Å—ã —Ç–µ–∫—É—â–µ–π –¥–æ—Å–∫–∏

  // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const editModal = document.getElementById('edit-modal');
  const editTitleInput = document.getElementById('edit-title');
  const editDescInput = document.getElementById('edit-desc');
  const editSaveBtn = document.getElementById('edit-save-btn');
  const editCancelBtn = document.getElementById('edit-cancel-btn');
  const editDeadlineInput = document.getElementById('edit-deadline');
  const editDialog = document.getElementById('edit-dialog');
  const editHeader = editDialog.querySelector('h3');
  const editColorInput = document.getElementById('edit-color');

  // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
  const fileInput = document.getElementById('file-input');
  const fileList = document.getElementById('file-list');
  const fileInfo = document.getElementById('file-info');
  const uploadProgress = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');

  // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  let isDragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  editHeader.addEventListener('mousedown', (e) => {
    isDragging = true;
    const rect = editDialog.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    editDialog.style.position = 'absolute';
    editDialog.style.margin = '0';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const x = e.clientX - dragOffsetX;
    const y = e.clientY - dragOffsetY;

    editDialog.style.left = x + 'px';
    editDialog.style.top = y + 'px';
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
  fileInput.addEventListener('change', function(e) {
    const files = e.target.files;
    if (files.length > 0) {
      fileInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ ${files.length} —Ñ–∞–π–ª(–æ–≤)`;
      uploadFiles(files);
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
  function uploadFiles(files) {
    if (!editingTaskId) {
      alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã');
      return;
    }

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
      formData.append('files', files[i]);
    }

    uploadProgress.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';

    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percentComplete + '%';
        progressText.textContent = percentComplete + '%';
      }
    });

    xhr.addEventListener('load', function() {
      if (xhr.status === 200) {
        const response = JSON.parse(xhr.responseText);
        loadTaskFiles(editingTaskId);
        fileInput.value = '';
        fileInfo.textContent = '–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
        setTimeout(() => {
          uploadProgress.style.display = 'none';
        }, 2000);
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤');
        uploadProgress.style.display = 'none';
      }
    });

    xhr.addEventListener('error', function() {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤');
      uploadProgress.style.display = 'none';
    });

    xhr.open('POST', `/api/tasks/${editingTaskId}/upload/`);
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
    xhr.send(formData);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –∑–∞–¥–∞—á–∏
  function loadTaskFiles(taskId) {
    fetch(`/api/tasks/${taskId}/files/`)
      .then(res => res.json())
      .then(files => {
        fileList.innerHTML = '';
        
        if (files.length === 0) {
          fileList.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 10px;">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>';
          return;
        }
        
        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.style.display = 'flex';
          fileItem.style.justifyContent = 'space-between';
          fileItem.style.alignItems = 'center';
          fileItem.style.padding = '8px';
          fileItem.style.borderBottom = '1px solid #eee';
          fileItem.style.backgroundColor = '#f8f9fa';
          fileItem.style.borderRadius = '4px';
          fileItem.style.marginBottom = '5px';
          
          const fileLink = document.createElement('a');
          fileLink.href = file.url;
          fileLink.textContent = file.name;
          fileLink.style.textDecoration = 'none';
          fileLink.style.color = '#0066cc';
          fileLink.target = '_blank';
          fileLink.style.flexGrow = '1';
          
          const fileSize = document.createElement('span');
          fileSize.textContent = formatFileSize(file.file_size);
          fileSize.style.fontSize = '12px';
          fileSize.style.color = '#666';
          fileSize.style.marginLeft = '10px';
          
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '√ó';
          deleteBtn.style.background = '#ff4444';
          deleteBtn.style.color = 'white';
          deleteBtn.style.border = 'none';
          deleteBtn.style.borderRadius = '50%';
          deleteBtn.style.width = '20px';
          deleteBtn.style.height = '20px';
          deleteBtn.style.cursor = 'pointer';
          deleteBtn.style.fontSize = '14px';
          deleteBtn.style.lineHeight = '1';
          
          deleteBtn.addEventListener('click', () => {
            deleteFile(taskId, file.id);
          });
          
          const fileInfoDiv = document.createElement('div');
          fileInfoDiv.style.display = 'flex';
          fileInfoDiv.style.alignItems = 'center';
          fileInfoDiv.style.flexGrow = '1';
          
          const fileIcon = document.createElement('span');
          fileIcon.textContent = getFileIcon(file.name);
          fileIcon.style.marginRight = '10px';
          fileIcon.style.fontSize = '16px';
          
          fileInfoDiv.appendChild(fileIcon);
          fileInfoDiv.appendChild(fileLink);
          fileInfoDiv.appendChild(fileSize);
          
          fileItem.appendChild(fileInfoDiv);
          fileItem.appendChild(deleteBtn);
          fileList.appendChild(fileItem);
        });
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', err);
        fileList.innerHTML = '<p style="color: red; text-align: center; padding: 10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</p>';
      });
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
      return 'üñºÔ∏è';
    } else if (ext === 'pdf') {
      return 'üìÑ';
    } else if (['doc', 'docx'].includes(ext)) {
      return 'üìù';
    } else if (['xls', 'xlsx'].includes(ext)) {
      return 'üìä';
    } else if (ext === 'txt') {
      return 'üìÉ';
    } else if (['zip', 'rar', '7z'].includes(ext)) {
      return 'üì¶';
    } else {
      return 'üìé';
    }
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
  function deleteFile(taskId, fileId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?')) return;
    
    fetch(`/api/tasks/${taskId}/files/${fileId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
    })
    .then(res => {
      if (res.ok) {
        loadTaskFiles(taskId);
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ñ–∞–π–ª–æ–≤
        fetchBoard();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
      }
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
    });
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  editCancelBtn.addEventListener('click', () => {
    editModal.style.display = 'none';
    editingTaskId = null;
    fileList.innerHTML = '';
    fileInfo.textContent = '';
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–¥–∞—á–∏
  editSaveBtn.addEventListener('click', () => {
    if (!editingTaskId) return;

    fetch(`/api/tasks/${editingTaskId}/update/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        title: editTitleInput.value,
        description: editDescInput.value,
        deadline: editDeadlineInput.value || null,
        color: editColorInput.value || null,
      }),
    })
    .then(res => {
      if (!res.ok) {
        return res.text().then(text => {
          console.error('Edit error response:', text);
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        });
      }
      return res.json();
    })
    .then(data => {
      // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–µ —Ñ–∞–π–ª—ã
      loadTaskFiles(editingTaskId);
      fetchBoard();  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É

        editModal.style.display = 'none';
        editingTaskId = null;
        fileList.innerHTML = '';
        fileInfo.textContent = '';

        console.log('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', data);
    })
    .catch(err => {
      console.error('EDIT ERROR:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è: ' + err.message);
    });
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      editModal.style.display = 'none';
      editingTaskId = null;
      fileList.innerHTML = '';
      fileInfo.textContent = '';

      editTitleInput.value = '';
      editDescInput.value = '';
      editDeadlineInput.value = '';
      editColorInput.value = '#008cff';
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å–∫–∏
  function fetchBoard() {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å–∫–∏, board_id:', currentBoardId);
    
    fetch(`/api/statuses/?board_id=${currentBoardId}`)
      .then(res => {
        if (!res.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${res.status} ${res.statusText}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('–ü–æ–ª—É—á–µ–Ω—ã —Å—Ç–∞—Ç—É—Å—ã:', data);
        renderBoard(data);
        updateStatusSelect(data); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å–∫–∏:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
      });
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
  function updateStatusSelect(statuses) {
    const statusSelect = document.getElementById('new-task-status');
    statusSelect.innerHTML = ''; // –û—á–∏—â–∞–µ–º
    
    if (statuses.length === 0) {
      statusSelect.innerHTML = '<option value="">–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤</option>';
      return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
    availableStatuses = statuses;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é –æ–ø—Ü–∏—é
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...';
    statusSelect.appendChild(emptyOption);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫
    statuses.forEach(status => {
      const option = document.createElement('option');
      option.value = status.id;
      option.textContent = status.name;
      statusSelect.appendChild(option);
    });
    
    console.log('–í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω, —Å—Ç–∞—Ç—É—Å–æ–≤:', statuses.length);
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
  function createTask() {
    const titleInput = document.getElementById('new-task-title');
    const statusSelect = document.getElementById('new-task-status');
    const deadlineInput = document.getElementById('new-task-deadline');

    const title = titleInput.value.trim();
    const statusId = statusSelect.value;
    const deadline = deadlineInput.value || null;

    console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:', {
      title: title,
      statusId: statusId,
      deadline: deadline,
      boardId: currentBoardId
    });

    if (!title) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      return;
    }

    if (!statusId) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞–¥–∞—á–∏');
      return;
    }

    fetch('/api/tasks/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        title: title,
        description: '',
        status: statusId,
        order: 1,
        deadline: deadline,
        board: currentBoardId,
      }),
    })
      .then(res => {
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å:', res.status, res.statusText);
        
        return res.text().then(text => {
          console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):', text.substring(0, 500));
          
          try {
            return JSON.parse(text);
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
            console.error('–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:', text);
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON');
          }
        });
      })
      .then(data => {
        console.log('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞, –¥–∞–Ω–Ω—ã–µ:', data);
        
        if (data.success === false) {
          throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        titleInput.value = '';
        deadlineInput.value = '';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É
        fetchBoard();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        if (data.message) {
          console.log('–°–æ–æ–±—â–µ–Ω–∏–µ:', data.message);
        }
      })
      .catch(err => {
        console.error('CREATE TASK ERROR:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É: ' + err.message);
      });
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å–∫–∏
  function renderBoard(columns) {
    console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å–∫–∏, –∫–æ–ª–æ–Ω–æ–∫:', columns.length);
    board.innerHTML = '';

    // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫—É "–í—Å–µ –∑–∞–¥–∞—á–∏" (—Å–≤–æ–¥–∫–∞)
    const summaryCol = document.createElement('div');
    summaryCol.className = 'column summary';
    summaryCol.style.order = '0';

    const summaryHeader = document.createElement('h3');
    summaryHeader.textContent = '–í—Å–µ –∑–∞–¥–∞—á–∏';

    const toggleBtn = document.createElement('button');
    toggleBtn.textContent = '‚àí';
    toggleBtn.style.float = 'right';
    toggleBtn.style.marginLeft = '10px';
    toggleBtn.style.cursor = 'pointer';
    toggleBtn.style.background = '#6ba8e0';
    toggleBtn.style.color = 'white';
    toggleBtn.style.border = 'none';
    toggleBtn.style.borderRadius = '3px';
    toggleBtn.style.padding = '2px 8px';

    const summaryTasks = document.createElement('div');
    summaryTasks.className = 'tasks-container';
    summaryTasks.style.display = summaryCollapsed ? 'none' : 'block';
    toggleBtn.textContent = summaryCollapsed ? '+' : '‚àí';
    
    summaryHeader.appendChild(toggleBtn);
    summaryCol.appendChild(summaryHeader);
    summaryCol.appendChild(summaryTasks);
    board.appendChild(summaryCol);

    toggleBtn.addEventListener('click', () => {
      summaryCollapsed = !summaryCollapsed;
      summaryTasks.style.display = summaryCollapsed ? 'none' : 'block';
      toggleBtn.textContent = summaryCollapsed ? '+' : '‚àí';
    });

    // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    columns.forEach(col => {
      const colDiv = document.createElement('div');
      colDiv.className = 'column';
      colDiv.dataset.statusId = col.id;
      colDiv.style.order = '1';

      const title = document.createElement('h3');
      title.textContent = col.name;
      colDiv.appendChild(title);

      const tasksContainer = document.createElement('div');
      tasksContainer.className = 'tasks-container';
      colDiv.appendChild(tasksContainer);

      console.log('–ó–∞–¥–∞—á–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ', col.name, ':', col.tasks.length);

      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –≤ –∫–æ–ª–æ–Ω–∫—É
      col.tasks.forEach(task => {
        const taskDiv = createTaskElement(task);
        tasksContainer.appendChild(taskDiv);

        // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –∑–∞–¥–∞—á–∏ –¥–ª—è —Å–≤–æ–¥–∫–∏
        const summaryTaskDiv = createTaskElement(task);
        summaryTaskDiv.addEventListener('click', () => {
          editingTaskId = task.id;
          editTitleInput.value = task.title;
          editDescInput.value = task.description || '';
          editDeadlineInput.value = task.deadline || '';
          editColorInput.value = task.color || '#008cff';
          editModal.style.display = 'flex';
          loadTaskFiles(task.id); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        });
        summaryTasks.appendChild(summaryTaskDiv);
      });

      colDiv.addEventListener('dragover', dragOver);
      colDiv.addEventListener('drop', drop);
      board.appendChild(colDiv);
    });
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏
  function createTaskElement(task) {
    const taskDiv = document.createElement('div');
    taskDiv.className = 'task';
    taskDiv.draggable = true;
    taskDiv.dataset.taskId = task.id;
    taskDiv.style.backgroundColor = task.color || 'rgb(0, 140, 255)';
    taskDiv.style.position = 'relative';
    taskDiv.style.padding = '10px 30px 10px 10px';
    taskDiv.style.margin = '8px 0';
    taskDiv.style.borderRadius = '4px';
    taskDiv.style.cursor = 'grab';
    taskDiv.style.overflow = 'visible';
    taskDiv.style.minHeight = '60px';
    taskDiv.style.zIndex = '1';

    const titleSpan = document.createElement('span');
    titleSpan.textContent = task.title;
    titleSpan.style.display = 'block';
    titleSpan.style.marginBottom = '6px';
    titleSpan.style.fontWeight = 'bold';
    titleSpan.style.wordBreak = 'break-word';
    titleSpan.style.paddingRight = '20px';

    const deadlineDiv = document.createElement('div');
    deadlineDiv.style.fontSize = '12px';
    deadlineDiv.style.color = '#333';
    deadlineDiv.style.marginTop = '4px';
    deadlineDiv.textContent = task.deadline ? `üìÖ ${task.deadline}` : '';

    // –ò–∫–æ–Ω–∫–∞ —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (task.files && task.files.length > 0) {
      const fileIcon = document.createElement('div');
      fileIcon.innerHTML = 'üìé';
      fileIcon.style.position = 'absolute';
      fileIcon.style.bottom = '5px';
      fileIcon.style.right = '5px';
      fileIcon.style.fontSize = '12px';
      fileIcon.title = `${task.files.length} —Ñ–∞–π–ª(–æ–≤)`;
      taskDiv.appendChild(fileIcon);
    }

    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '√ó';
    deleteBtn.style.position = 'absolute';
    deleteBtn.style.top = '8px';
    deleteBtn.style.right = '8px';
    deleteBtn.style.background = 'rgba(255, 255, 255, 0.9)';
    deleteBtn.style.color = '#ff4444';
    deleteBtn.style.border = '1px solid #ff4444';
    deleteBtn.style.borderRadius = '50%';
    deleteBtn.style.width = '20px';
    deleteBtn.style.height = '20px';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.fontSize = '16px';
    deleteBtn.style.fontWeight = 'bold';
    deleteBtn.style.lineHeight = '1';
    deleteBtn.style.display = 'flex';
    deleteBtn.style.alignItems = 'center';
    deleteBtn.style.justifyContent = 'center';
    deleteBtn.style.padding = '0';
    deleteBtn.style.margin = '0';
    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É';
    deleteBtn.style.zIndex = '10';

    // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    deleteBtn.onmouseover = function() {
        this.style.background = '#ff4444';
        this.style.color = 'white';
    };
    deleteBtn.onmouseout = function() {
        this.style.background = 'rgba(255, 255, 255, 0.9)';
        this.style.color = '#ff4444';
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const taskId = taskDiv.dataset.taskId;
        console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:', taskId);
        
        fetch(`/api/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => {
                    console.error('Delete error:', text);
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                });
            }
            return res.text();
        })
        .then(() => {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ—Å–∫–∏
            taskDiv.remove();
            // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–≤–æ–¥–∫–∏
            const summaryCard = document.querySelector(
                `.column.summary .task[data-task-id="${taskId}"]`
            );
            if (summaryCard) {
                summaryCard.remove();
            }
            console.log('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞:', taskId);
        })
        .catch(err => {
            console.error('DELETE ERROR:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É: ' + err.message);
        });
    });

    taskDiv.appendChild(titleSpan);
    taskDiv.appendChild(deadlineDiv);
    taskDiv.appendChild(deleteBtn);

    taskDiv.addEventListener('dragstart', dragStart);
    taskDiv.addEventListener('dragend', dragEnd);
    
    // –ö–ª–∏–∫ –ø–æ –∑–∞–¥–∞—á–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    taskDiv.addEventListener('click', (e) => {
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        if (e.target === deleteBtn || deleteBtn.contains(e.target)) {
            return;
        }
        
        editingTaskId = task.id;
        editTitleInput.value = task.title;
        editDescInput.value = task.description || '';
        editDeadlineInput.value = task.deadline || '';
        editColorInput.value = task.color || '#008cff';
        editModal.style.display = 'flex';
        loadTaskFiles(task.id); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    });

    return taskDiv;
  }

  // Drag and Drop —Ñ—É–Ω–∫—Ü–∏–∏
  function dragStart(e) {
    draggedTask = e.target;
    e.dataTransfer.setData('text/plain', null);
    setTimeout(() => {
      e.target.style.opacity = '0.4';
    }, 0);
    console.log('–ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', e.target.dataset.taskId);
  }

  function dragEnd(e) {
    e.target.style.opacity = '1';
    draggedTask = null;
    console.log('–ö–æ–Ω–µ—Ü –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
  }

  function dragOver(e) {
    e.preventDefault();
  }

  function drop(e) {
    e.preventDefault();
    if (!draggedTask) return;

    draggedTask.style.opacity = '1';
    
    const newStatusId = this.dataset.statusId;
    const taskId = draggedTask.dataset.taskId;

    console.log('–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏', taskId, '–≤ —Å—Ç–∞—Ç—É—Å', newStatusId);

    const tasksContainer = this.querySelector('.tasks-container') || this;
    tasksContainer.appendChild(draggedTask);

    fetch(`/api/tasks/${taskId}/update/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({status: newStatusId}),
    })
    .then(res => {
      if (!res.ok) {
        return res.text().then(text => {
          console.error('Update error:', text);
          throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        });
      }
      return res.json();
    })
    .then(data => {
      console.log('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', data);
    })
    .catch(err => {
      console.error('DROP ERROR:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏: ' + err.message);
      fetchBoard(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }


  // –í base.html –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç
function checkSession() {
    fetch('/api/check-session/')
        .then(response => response.json())
        .then(data => {
            const currentUsername = "{{ user.username|escapejs }}";
            
            if (data.authenticated && data.username !== currentUsername) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (confirm(`–û–±–Ω–∞—Ä—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (${data.username}). –í—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ?`)) {
                    window.location.href = '{% url "logout" %}';
                }
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error));
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(checkSession, 30000);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', checkSession);
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É...');
    fetchBoard();
  });
</script>
{% endblock %}