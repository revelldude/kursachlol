{% extends 'kanban/base.html' %}

{% block title %}–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß - –î–æ—Å–∫–∞{% endblock %}

{% block content %}
  <h1>–ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ó–ê–î–ê–ß</h1>
  <div style="margin: 10px 0;">
    <div class="task-input-wrapper">
      <input id="new-task-title"
             type="text"
             placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞"
             class="task-title-input" />

      <input id="new-task-deadline"
             type="date"
             class="task-date-input" />

      <span class="task-date-icon">üìÖ</span>
    </div>

    <select id="new-task-status" style="margin-left: 10px;">
      <option value="1">–û–∂–∏–¥–∞–Ω–∏–µ</option>
      <option value="2">–í —Ä–∞–±–æ—Ç–µ</option>
      <option value="3">–í—ã–ø–æ–ª–Ω–µ–Ω—ã</option>
    </select>

    <button onclick="createTask()" style="margin-left: 8px;">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div id="board" class="board"></div>

  <div id="edit-modal" style="display:none;
                               position:fixed;
                               top:0; left:0; right:0; bottom:0;
                               background:rgba(0,0,0,0.4);
                               align-items:center;
                               justify-content:center;">
    <div id="edit-dialog" style="background:white; padding:16px; border-radius:8px; width:300px;">
      <h3 id="edit-dialog-header" style="cursor: move; margin-top:0;">
      –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</h3>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><br>
      <input id="edit-title" type="text" style="width:100%; margin-bottom:8px;"><br>
      <label>–ó–∞–º–µ—Ç–∫–∞:</label><br>
      <textarea id="edit-desc" rows="4"></textarea><br><br>
      <label>–î–µ–¥–ª–∞–π–Ω:</label><br>
      <input id="edit-deadline" type="date" style="width:100%; margin-bottom:8px;"><br>
      <label>–¶–≤–µ—Ç –∑–∞–¥–∞—á–∏:</label><br>
      <input id="edit-color" type="color" style="width:100%; margin-bottom:8px;"><br>
      <button id="edit-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="edit-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  console.log('KANBAN SCRIPT LOADED');

  const board = document.getElementById('board');
  let draggedTask = null;
  let editingTaskId = null;
  let summaryCollapsed = true;

  const editModal = document.getElementById('edit-modal');
  const editTitleInput = document.getElementById('edit-title');
  const editDescInput = document.getElementById('edit-desc');
  const editSaveBtn = document.getElementById('edit-save-btn');
  const editCancelBtn = document.getElementById('edit-cancel-btn');
  const editDeadlineInput = document.getElementById('edit-deadline');
  const editDialog = document.getElementById('edit-dialog');
  const editHeader = editDialog.querySelector('h3');
  const editColorInput = document.getElementById('edit-color');

  let isDragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  editHeader.addEventListener('mousedown', (e) => {
    isDragging = true;
    const rect = editDialog.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    editDialog.style.position = 'absolute';
    editDialog.style.margin = '0';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const x = e.clientX - dragOffsetX;
    const y = e.clientY - dragOffsetY;

    editDialog.style.left = x + 'px';
    editDialog.style.top = y + 'px';
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  editCancelBtn.addEventListener('click', () => {
    editModal.style.display = 'none';
    editingTaskId = null;
  });

  editSaveBtn.addEventListener('click', () => {
    if (!editingTaskId) return;

    fetch(`/api/tasks/${editingTaskId}/update/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        title: editTitleInput.value,
        description: editDescInput.value,
        deadline: editDeadlineInput.value || null, 
        color: editColorInput.value || null,
      }),
    })
    .then(res => {
      if (!res.ok) {
        return res.json().then(err => { throw err; });
      }
      return res.json();
    })
    .then(data => {
      editModal.style.display = 'none';
      editingTaskId = null;
      fetchBoard();  
    })
    .catch(err => {
      console.error('EDIT ERROR:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
    });
  });

  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      editModal.style.display = 'none';
      editingTaskId = null;
    }
  });

  function fetchBoard() {
    fetch('/api/statuses/')
      .then(res => res.json())
      .then(data => {
        console.log('STATUSES FROM API:', data);
        renderBoard(data);
    });
  }

  function createTask() {
    const titleInput = document.getElementById('new-task-title');
    const statusSelect = document.getElementById('new-task-status');
    const deadlineInput = document.getElementById('new-task-deadline');

    const title = titleInput.value.trim();
    const statusId = statusSelect.value;
    const deadline = deadlineInput.value || null;

    if (!title) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      return;
    }

    fetch('/api/tasks/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
        title: title,
        description: '',
        status: statusId,
        order: 1,
        deadline: deadline,
      }),
    })
      .then(res => {
        if (!res.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
        }
        return res.json();
      })
      .then(data => {
        titleInput.value = '';
        deadlineInput.value = '';
        fetchBoard(); 
      })
      .catch(err => {
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É');
      });
  }

  function renderBoard(columns) {
    console.log('RENDER BOARD CALLED with:', columns);
    board.innerHTML = '';

    const summaryCol = document.createElement('div');
    summaryCol.className = 'column summary';
    summaryCol.style.order = '0';

    const summaryHeader = document.createElement('h3');
    summaryHeader.textContent = '–í—Å–µ –∑–∞–¥–∞—á–∏';

    const toggleBtn = document.createElement('button');
    toggleBtn.textContent = '‚àí';
    toggleBtn.style.float = 'right';

    const summaryTasks = document.createElement('div');
    summaryTasks.className = 'tasks-container';
    summaryTasks.style.display = summaryCollapsed ? 'none' : 'block';  
    toggleBtn.textContent = summaryCollapsed ? '+' : '‚àí';
    
    summaryHeader.appendChild(toggleBtn);
    summaryCol.appendChild(summaryHeader);
    summaryCol.appendChild(summaryTasks);
    board.appendChild(summaryCol);

    toggleBtn.addEventListener('click', () => {
      summaryCollapsed = !summaryCollapsed;
      summaryTasks.style.display = summaryCollapsed ? 'none' : 'block';
      toggleBtn.textContent = summaryCollapsed ? '+' : '‚àí';
    });

    columns.forEach(col => {
      const colDiv = document.createElement('div');
      colDiv.className = 'column';
      colDiv.dataset.statusId = col.id;
      colDiv.style.order = '1';

      const title = document.createElement('h3');
      title.textContent = col.name;
      colDiv.appendChild(title);

      const tasksContainer = document.createElement('div');
      tasksContainer.className = 'tasks-container';
      colDiv.appendChild(tasksContainer);

      console.log('TASKS IN COLUMN', col.name, col.tasks);

      col.tasks.forEach(task => {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task';
        taskDiv.draggable = true;
        taskDiv.dataset.taskId = task.id;
        taskDiv.style.backgroundColor = task.color || 'rgb(0, 140, 255)';

        const titleSpan = document.createElement('span');
        titleSpan.textContent = task.title;

        const deadlineDiv = document.createElement('div');
        deadlineDiv.style.fontSize = '12px';
        deadlineDiv.style.marginTop = '4px';
        deadlineDiv.textContent = task.deadline ? `–î–µ–¥–ª–∞–π–Ω: ${task.deadline}` : '';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '√ó';
        deleteBtn.style.marginLeft = '8px';
        deleteBtn.style.float = 'right';
        deleteBtn.style.cursor = 'pointer';

        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();

          const taskId = taskDiv.dataset.taskId;
          fetch(`/api/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
          })
            .then(res => {
              if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
              taskDiv.remove();
            const summaryCard = document.querySelector(
          `.column.summary .task[data-task-id="${taskId}"]`
        );
        if (summaryCard) {
          summaryCard.remove();
        }
            })
            .catch(err => {
              console.error('DELETE ERROR:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
            });
        });

        taskDiv.addEventListener('dragstart', dragStart);
        taskDiv.addEventListener('dragend', dragEnd);
        taskDiv.addEventListener('click', () => {
          editingTaskId = task.id;
          editTitleInput.value = task.title;
          editDescInput.value = task.description || '';
        editDeadlineInput.value = task.deadline || '';
        editColorInput.value = task.color || '#008cff'; 
        editModal.style.display = 'flex';
      });

      taskDiv.appendChild(titleSpan);
      taskDiv.appendChild(deadlineDiv);
      taskDiv.appendChild(deleteBtn);
      tasksContainer.appendChild(taskDiv);

      const summaryTaskDiv = document.createElement('div');
      summaryTaskDiv.className = 'task';
      summaryTaskDiv.dataset.taskId = task.id; 
      summaryTaskDiv.style.backgroundColor = task.color || 'rgb(0, 140, 255)';

      const summaryTitle = document.createElement('span');
      summaryTitle.textContent = task.title;
      summaryTaskDiv.appendChild(summaryTitle);

      const summaryDeadline = document.createElement('div');
      summaryDeadline.style.fontSize = '12px';
      summaryDeadline.style.marginTop = '4px';
      summaryDeadline.textContent = task.deadline ? `–î–µ–¥–ª–∞–π–Ω: ${task.deadline}` : '';
      summaryTaskDiv.appendChild(summaryDeadline);

      summaryTaskDiv.addEventListener('click', () => {
        editingTaskId = task.id;
        editTitleInput.value = task.title;
        editDescInput.value = task.description || '';
        editDeadlineInput.value = task.deadline || '';
        editModal.style.display = 'flex';
      });

      summaryTasks.appendChild(summaryTaskDiv);
    });

    colDiv.addEventListener('dragover', dragOver);
    colDiv.addEventListener('drop', drop);
    board.appendChild(colDiv);
    });
  }

  function dragStart(e) {
    draggedTask = e.target;
    e.dataTransfer.setData('text/plain', null);
  }
  function dragEnd() {
    draggedTask = null;
  }
  function dragOver(e) {
    e.preventDefault();
  }
  function drop(e) {
    e.preventDefault();
    if (!draggedTask) return;

    const newStatusId = this.dataset.statusId;
    const taskId = draggedTask.dataset.taskId;

    const tasksContainer = this.querySelector('.tasks-container') || this;
    tasksContainer.appendChild(draggedTask);

    fetch(`/api/tasks/${taskId}/update/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({status: newStatusId}),
    }).then(res => {
      if (!res.ok) {
        return res.json().then(err => {
          console.error('UPDATE ERROR:', err);
          throw err;
        });
      }
      return res.json();
    })
      .then(data => {
        console.log('UPDATED TASK RESPONSE:', data);
      })
      .catch(err => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
        fetchBoard();
      });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
    return cookieValue;
  }
}

  fetchBoard();
</script>
{% endblock %}