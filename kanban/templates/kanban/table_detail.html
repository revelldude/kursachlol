{% extends 'kanban/base.html' %}
{% load static %}

{% block title %}{{ table.name }} - –¢–∞–±–ª–∏—Ü–∞{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã -->
    <div class="d-flex justify-content-between align-items-center mb-4" 
         style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
        <div>
            <h1 style="color: #333; margin: 0;">{{ table.name }}</h1>
            {% if table.description %}
            <p class="text-muted mt-2">{{ table.description }}</p>
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#addColumnModal"
                    style="border-color: #6ba8e0; color: #6ba8e0;">
                + –ö–æ–ª–æ–Ω–∫–∞
            </button>
            <button class="btn btn-primary btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#addRowModal"
                    style="background: #6ba8e0; border: none;">
                + –°—Ç—Ä–æ–∫–∞
            </button>
            <a href="{% url 'table_list' %}" 
               class="btn btn-secondary btn-sm">
                ‚Üê –ö —Å–ø–∏—Å–∫—É
            </a>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="table-responsive" style="background: white; border-radius: 8px; border: 1px solid #dee2e6;">
        <table class="table table-bordered mb-0" id="task-table">
            <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background: #f8f9fa;">
                <tr>
                    <th style="width: 50px; min-width: 50px; background: #6ba8e0; color: white; border-color: #6ba8e0;">
                        #
                    </th>
                    
                    {% for column in columns %}
                    <th style="border-left: 2px solid #dee2e6; min-width: {{ column.width|default:150 }}px;" 
                        data-column-id="{{ column.id }}">
                        <div class="d-flex justify-content-between align-items-center column-header">
                            <span>{{ column.name }}</span>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary"
                                    onclick="editColumn('{{ column.id }}')"
                                    style="border: none; padding: 2px 6px; border-radius: 4px; background: #f8f9fa;">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </th>
                    {% endfor %}
                    
                    <th style="width: 50px; min-width: 50px; border-left: 2px solid #dee2e6;">
                        <button class="btn btn-sm btn-outline-secondary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#addColumnModal"
                                style="border: none; padding: 5px 10px; background: #f8f9fa; border-radius: 4px;">
                            +
                        </button>
                    </th>
                </tr>
            </thead>
                        <tbody>
                {% for row in rows %}
                <tr style="border-top: 1px solid #dee2e6;" data-row-id="{{ row.id }}">
                    <td class="text-center text-muted" style="background: #f8f9fa; border-right: 2px solid #dee2e6;">
                        {{ forloop.counter }}
                        <button class="btn btn-sm btn-outline-danger ms-1"
                                onclick="deleteRow('{{ row.id }}')"
                                style="border: none; padding: 0 5px; font-size: 16px; background: transparent;">
                            √ó
                        </button>
                    </td>
                    
                    {% for column in columns %}
                    <td class="cell-editable" 
                        onclick="editCell(this, '{{ row.id }}', '{{ column.id }}')"
                        style="cursor: pointer; padding: 12px; border-left: 1px solid #dee2e6; min-height: 60px; vertical-align: top;"
                        onmouseover="this.style.backgroundColor='#f0f7ff'"
                        onmouseout="this.style.backgroundColor='white'"
                        data-row-id="{{ row.id }}"
                        data-column-id="{{ column.id }}">
                        {% comment %} –ò—â–µ–º —è—á–µ–π–∫—É –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–ª–æ–Ω–∫–∏ {% endcomment %}
                        {% with cell_found=False %}
                            {% for cell in cells %}
                                {% if cell.row.id == row.id and cell.column.id == column.id %}
                                    {% if cell.content %}
                                        {{ cell.content|linebreaksbr }}
                                    {% else %}
                                        <span class="text-muted" style="opacity: 0.6;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                                    {% endif %}
                                    {% with cell_found=True %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                            {% if not cell_found %}
                                <span class="text-muted" style="opacity: 0.6;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                    
                    <td style="background: #f8f9fa; border-left: 2px solid #dee2e6;"></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ columns|length|add:2 }}" class="text-center text-muted py-5">
                        <div style="font-size: 48px; color: #6ba8e0; display: block; margin-bottom: 15px;">üìã</div>
                        –ù–µ—Ç —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
                        <div class="mt-3">
                            <button class="btn btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#addRowModal"
                                    style="background: #6ba8e0; border: none; padding: 8px 16px;">
                                + –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –≤–Ω–∏–∑—É -->
    <div class="mt-3">
        <button class="btn btn-primary" 
                data-bs-toggle="modal" 
                data-bs-target="#addRowModal"
                style="background: #6ba8e0; border: none; padding: 10px 20px;">
            + –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
        </button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ -->
<div class="modal fade" id="addColumnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="background: #6ba8e0; color: white; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="color: #333; font-weight: 500;">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏</label>
                    <input type="text" id="newColumnName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π">
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #333; font-weight: 500;">–®–∏—Ä–∏–Ω–∞ (px)</label>
                    <input type="number" id="newColumnWidth" class="form-control" value="200" min="50" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="addColumn()" style="background: #6ba8e0; border: none;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ -->
<div class="modal fade" id="addRowModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="background: #6ba8e0; color: white; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="color: #333; font-weight: 500;">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏</label>
                    <input type="text" id="newRowTitle" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="addRow()" style="background: #6ba8e0; border: none;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏ -->
<div class="modal fade" id="editCellModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="background: #6ba8e0; color: white; border-radius: 8px 8px 0 0;">
                <h5 class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <textarea class="form-control" id="editCellContent" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveCell()" style="background: #6ba8e0; border: none;">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const TABLE_ID = '{{ table.id }}';
let currentCellElement = null;
let currentRowId = null;
let currentColumnId = null;

// –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
function addColumn() {
    const name = document.getElementById('newColumnName').value.trim();
    const width = document.getElementById('newColumnWidth').value;
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏');
        return;
    }
    
    fetch('/tables/ajax/add-column/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            table_id: TABLE_ID,
            name: name,
            width: parseInt(width) || 200
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    bootstrap.Modal.getInstance(document.getElementById('addColumnModal')).hide();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
function addRow() {
    const title = document.getElementById('newRowTitle').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏');
        return;
    }
    
    fetch('/tables/ajax/add-row/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            table_id: TABLE_ID,
            title: title
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    bootstrap.Modal.getInstance(document.getElementById('addRowModal')).hide();
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
function deleteRow(rowId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?')) return;
    
    fetch(`/tables/ajax/delete-row/${rowId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    });
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏
function editCell(element, rowId, columnId) {
    currentCellElement = element;
    currentRowId = rowId;
    currentColumnId = columnId;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç
    let content = '';
    if (element.querySelector('.text-muted')) {
        content = '';
    } else {
        content = element.textContent.trim();
    }
    
    document.getElementById('editCellContent').value = content;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('editCellModal'));
    modal.show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —è—á–µ–π–∫–∏
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏
function saveCell() {
    const content = document.getElementById('editCellContent').value.trim();
    
    if (!currentRowId || !currentColumnId) return;
    
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL —á–µ—Ä–µ–∑ Django template tag
    fetch("{% url 'ajax_update_cell' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({
            table_id: TABLE_ID,
            row_id: currentRowId,
            column_id: currentColumnId,
            content: content
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —è—á–µ–π–∫–∏
            if (content) {
                currentCellElement.innerHTML = content.replace(/\n/g, '<br>');
            } else {
                currentCellElement.innerHTML = '<span class="text-muted" style="opacity: 0.6;">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>';
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('editCellModal')).hide();
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).');
    });
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
function editColumn(columnId) {
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:');
    if (newName && newName.trim()) {
        fetch('/tables/ajax/edit-column/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                column_id: columnId,
                name: newName.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏');
        });
    }
}

// –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.cell-editable').forEach(cell => {
        cell.addEventListener('dblclick', function() {
            const rowId = this.getAttribute('data-row-id');
            const columnId = this.getAttribute('data-column-id');
            editCell(this, rowId, columnId);
        });
    });
});
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
.table th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa !important;
    z-index: 10;
}

#task-table {
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

#task-table td, #task-table th {
    vertical-align: top;
    border: 1px solid #dee2e6;
}

.cell-editable {
    min-height: 60px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.cell-editable:hover {
    background-color: #f0f7ff !important;
}

.column-header {
    padding: 8px 12px;
}

.form-control:focus {
    border-color: #6ba8e0;
    box-shadow: 0 0 0 0.2rem rgba(107, 168, 224, 0.25);
}

.modal-content {
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.btn-outline-primary {
    border-color: #6ba8e0;
    color: #6ba8e0;
}

.btn-outline-primary:hover {
    background-color: #6ba8e0;
    border-color: #6ba8e0;
}
</style>
{% endblock %}